<!DOCTYPE HTML>
<html>
<head>
    <title>Tweet Location Filter</title>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
    <link rel="stylesheet" href="../static/ammap/ammap.css" type="text/css">
    <script src="../static/ammap/ammap.js" type="text/javascript"></script>
    <script src="https://www.amcharts.com/lib/3/themes/dark.js"></script>
    <!-- map file should be included after ammap.js -->
    <script src="../static/ammap/usaLow.js" type="text/javascript"></script>
    <script>
        	</script>
    <script type="text/javascript" charset="utf-8">
        var map;

        var tweetCount = 0;

        AmCharts.ready(function() {
            map = new AmCharts.AmMap();
            AmCharts.theme = AmCharts.themes.dark;
            map.zoomControl.homeButtonEnabled = false;
            map.colorSteps = 10;
            map.zoomControl.zoomControlEnabled = false;
            
            var dataProvider = {
                mapVar: AmCharts.maps.usaLow,

                areas: [
                    {
                    id: "US-AL",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-AK",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                    
                },
                {
                    id: "US-AZ",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-AR",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-CA",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-CO",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-CT",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-DE",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-FL",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-GA",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-HI",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-ID",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-IL",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-IN",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-IA",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-KS",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-KY",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-LA",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-ME",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-MD",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-MA",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-MI",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-MN",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-MS",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-MO",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-MT",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-NE",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-NV",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-NH",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-NJ",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-NM",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-NY",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-NC",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-ND",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-OH",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-OK",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-OR",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-PA",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-RI",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-SC",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-SD",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-TN",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-TX",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-UT",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-VT",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-VA",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-WA",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-WV",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-WI",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-WY",
                    value: 0,
                    color: "#d9d9d9",
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                }]
            };

            map.areasSettings = {
                autoZoom: false
            };
            map.dataProvider = dataProvider;

            var valueLegend = new AmCharts.ValueLegend();
            valueLegend.right = 10;
            valueLegend.minValue = "Less Tweets";
            valueLegend.maxValue = "More Tweets";
            valueLegend.showAsGradient = true;
            map.valueLegend = valueLegend;
            map.write("mapdiv");
        });

            function stateSentimentScores(){
            this.pos = 0;
            this.neg = 0;
            

            function addPos(){
                this.pos++;
            }

            function addNeg(){
                this.neg++;
            }

            function getPos(){
                return this.pos;
            }

            function getNeg(){
                return this.neg;
            }

            this.addPos = addPos;
            this.addNeg = addNeg;
            this.getPos = getPos;
            this.getNeg = getNeg;
        }

        updateMap = true;

        sentimentScores = [];
        for(i = 0; i < 50; i++){
            sentimentScores[i] = new stateSentimentScores();
        }

		function addToState(tweet){
			var areaArray = map.dataProvider.areas;
			for(var x = 0; x < areaArray.length; x++){
				if(areaArray[x].id == tweet.data){
                    areaArray[x].value += 1;
                    if(parseFloat(tweet.sentiment) != 0){
                        sentimentScores[x] = (sentimentScores[x] + parseFloat(tweet.sentiment)) / areaArray[x].value;
                    }
                    areaArray[x].description = sentimentScores[x];
                    tweetCount++;
                    document.getElementById("tweets").innerHTML = tweetCount;
				}
			}
			map.validateData();
		}

        function checkSentiment(state) {
            var areaArray = map.dataProvider.areas;
            var sentimentIndex;
            for(var x = 0; x < areaArray.length; x++){
                if(areaArray[x].id == state){
                    if(sentimentScores[x].pos > sentimentScores[x].neg){
                        if((sentimentScores[x].pos / sentimentScores[x].neg) > 2){
                            return 7;
                        } else if((sentimentScores[x].pos / sentimentScores[x].neg) > 1.5){
                            return 6;
                        }else{
                            return 5;
                        }
                    }else if(sentimentScores[x].pos < sentimentScores[x].neg){
                        if((sentimentScores[x].neg / sentimentScores[x].pos) > 2){
                            return 3;
                        } else if((sentimentScores[x].neg / sentimentScores[x].pos) > 1.5){
                            return 2;
                        }else{
                            return 1;
                        }                    
                    }else{
                        return 4;
                    }
                }    
            }
        }

        function addSentiment(tweet){
            var areaArray = map.dataProvider.areas;
            for(var x = 0; x < areaArray.length; x++){
                if(areaArray[x].id == tweet.data){
                    areaArray[x].value += 1;
                    if(parseFloat(tweet.sentiment) > 0){
                        sentimentScores[x].addPos();
                    } else if(parseFloat(tweet.sentiment) < 0){
                        sentimentScores[x].addNeg();
                    }
                    var sv = checkSentiment(tweet.data);

                    if( sv == 4 )
                        areaArray[x].color = "#d9d9d9";
                    else if( sv == 5 )
                        areaArray[x].color = "#ccffcc";
                    else if( sv == 6 )
                        areaArray[x].color = "#33ff33";
                    else if( sv == 7 )
                        areaArray[x].color = "#009900";
                    else if( sv == 3 )
                        areaArray[x].color = "#ffb3b3";
                    else if( sv == 2 )
                        areaArray[x].color = "#ff4d4d";
                    else if( sv == 1 )
                        areaArray[x].color = "#cc0000";
                    tweetCount++;
                    document.getElementById("tweets").innerHTML = tweetCount;
                }
            }
            if(updateMap){
                map.validateData();
            }
        }

		function sleep(milliseconds) {
		  var start = new Date().getTime();
		  for (var i = 0; i < 1e7; i++) {
		    if ((new Date().getTime() - start) > milliseconds){
		      break;
		    }
		  }
		}

        var socket;

        $(document).ready(function() {
            // Use a "/test" namespace.
            // An application can open a connection on multiple namespaces, and
            // Socket.IO will multiplex all those connections on a single
            // physical channel. If you don't care about multiple channels, you
            // can set the namespace to an empty string.
            namespace = '/stream';

            // Connect to the Socket.IO server.
            // The connection URL has the following format:
            //     http[s]://<domain>:<port>[/<namespace>]
            socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port + namespace);

            // Event handler for new connections.
            // The callback function is invoked when a connection with the
            // server is established.
            socket.on('connect', function() {
                socket.emit('my_event', {data: 'I\'m connected!'});
            });

            socket.on('tweet', function(msg){
                addSentiment(msg);
                $('#log').append('<br>' + $('<div/>').text('Location: ' + msg.data + ' - Sentiment: ' + msg.sentiment).html());
            });


            // Handlers for the different forms in the page.
            // These accept data from the user and send it to the server in a
            // variety of ways
            $('form#emit').submit(function(event) {
                socket.emit('new_filter', {data: $('#emit_data').val()});
                $("#log").html("");
                return false;
            });
        });
        function disconnect(){
            socket.emit('dis');
        }
        window.onbeforeunload = function() {
            disconnect();
            return null;
        }

    </script>
    
</head>
<body>
    <h1>Tweet Location Search</h1>
    <h2>Filter:</h2>
    <h4>Tweets: </h4>
    <div id="tweets"></div>
    <form id="emit" method="POST" action='#'>
        <input type="text" name="emit_data" id="emit_data" placeholder="Message">
        <input type="submit" value="Submit">
    </form>
    <div id="mapdiv" style="width: 100%; background-color:#fff; height: 500px;"></div>
    
    <h2>Locations:</h2>
    <div id="log"></div>
    <button type="button" onclick="testye()">YEET</button>
</body>
</html>