<!DOCTYPE HTML>
<html>
<head>
    <title>Tweet Location Filter</title>

    <link rel="stylesheet" href="../static/ammap/ammap.css" type="text/css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    
    <script src="../static/ammap/ammap.js" type="text/javascript"></script>
    <script src="https://www.amcharts.com/lib/3/themes/light.js"></script>
    <!-- map file should be included after ammap.js -->
    <script src="../static/ammap/usaLow.js" type="text/javascript"></script>
    <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        var map;

        var tweetCount = 0;

        AmCharts.ready(function() {
            map = new AmCharts.AmMap();
            AmCharts.theme = AmCharts.themes.light;
            map.zoomControl.homeButtonEnabled = false;
            map.colorSteps = 10;
            map.zoomControl.zoomControlEnabled = false;
            
            var dataProvider = {
                mapVar: AmCharts.maps.usaLow,

                areas: [
                    {
                    id: "US-AL",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-AK",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                    
                },
                {
                    id: "US-AZ",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-AR",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-CA",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-CO",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-CT",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-DE",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-FL",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-GA",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-HI",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-ID",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-IL",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-IN",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-IA",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-KS",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-KY",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-LA",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-ME",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-MD",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-MA",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-MI",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-MN",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-MS",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-MO",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-MT",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-NE",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-NV",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-NH",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-NJ",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-NM",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-NY",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-NC",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-ND",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-OH",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-OK",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-OR",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-PA",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-RI",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-SC",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-SD",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-TN",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-TX",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-UT",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-VT",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-VA",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-WA",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-WV",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-WI",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                },
                {
                    id: "US-WY",
                    value: 0,
                    fontsize: 20,
                    description : "No data",
                    balloonText: "<b>[[title]]</b><br/>Sentiment: [[description]]<br/><br/>Tweets: [[value]]<br/>[[percent]]% of all US Tweets"
                }]
            };

            map.areasSettings = {
                autoZoom: false
            };
            map.dataProvider = dataProvider;

            var valueLegend = new AmCharts.ValueLegend();
            valueLegend.right = 10;
            valueLegend.minValue = "Less Tweets";
            valueLegend.maxValue = "More Tweets";
            valueLegend.showAsGradient = true;
            map.valueLegend = valueLegend;
            map.write("mapdiv");
        });

        function stateSentimentScores(){
            this.pos = 0;
            this.neg = 0;
            

            function addPos(){
                this.pos++;
            }

            function addNeg(){
                this.neg++;
            }

            function getPos(){
                return this.pos;
            }

            function getNeg(){
                return this.neg;
            }

            this.addPos = addPos;
            this.addNeg = addNeg;
            this.getPos = getPos;
            this.getNeg = getNeg;
        }

        sentimentScores = [];
        for(i = 0; i < 50; i++){
            sentimentScores[i] = new stateSentimentScores();
        }

        updateMap = true;

		function addToState(tweet){
			var areaArray = map.dataProvider.areas;
			for(var x = 0; x < areaArray.length; x++){
				if(areaArray[x].id == tweet.data){
                    areaArray[x].value += 1;
                    if(parseFloat(tweet.sentiment) > 0){
                        sentimentScores[x].addPos();
                    } else if(parseFloat(tweet.sentiment) < 0){
                        sentimentScores[x].addNeg();
                    }

                    if(sentimentScores[x].pos > sentimentScores[x].neg){
                        if((sentimentScores[x].pos / sentimentScores[x].neg) > 2){
                            areaArray[x].description = "Positive: " +  (sentimentScores[x].pos / sentimentScores[x].neg);
                        } else if((sentimentScores[x].pos / sentimentScores[x].neg) > 1.5){
                            areaArray[x].description = "Somewhat Positive: " + (sentimentScores[x].pos / sentimentScores[x].neg);
                        }else{
                            areaArray[x].description = "Slightly Positive: " + (sentimentScores[x].pos / sentimentScores[x].neg);
                        }
                    }else if(sentimentScores[x].pos < sentimentScores[x].neg){
                        if((sentimentScores[x].neg / sentimentScores[x].pos) > 2){
                            areaArray[x].description = "Negative: " + (sentimentScores[x].neg / sentimentScores[x].pos);
                        } else if((sentimentScores[x].neg / sentimentScores[x].pos) > 1.5){
                            areaArray[x].description = "Somewhat Negative: " + (sentimentScores[x].pos / sentimentScores[x].neg) ;
                        }else{
                            areaArray[x].description = "Slightly Negative: " + (sentimentScores[x].pos / sentimentScores[x].neg);
                        }                    
                    }else{
                        areaArray[x].description = "Neutral";
                    }
                    tweetCount++;
                    document.getElementById("tweets").innerHTML = tweetCount;
				}
			}
            if(updateMap){
                map.validateData();
            }
		}


		function sleep(milliseconds) {
		  var start = new Date().getTime();
		  for (var i = 0; i < 1e7; i++) {
		    if ((new Date().getTime() - start) > milliseconds){
		      break;
		    }
		  }
		}
        function clearMap(){
            var areaArray = map.dataProvider.areas;
            updateMap = true;
            tweetCount = 0;
            for(i = 0; i < 50; i++){
                sentimentScores[i] = new stateSentimentScores();
            }
            for(var x = 0; x < areaArray.length; x++){
                areaArray[x].value = 0;
                areaArray[x].description = "Neutral";
            }

            map.validateData();
        }
        var socket;

        $(document).ready(function() {
            // Use a "/test" namespace.
            // An application can open a connection on multiple namespaces, and
            // Socket.IO will multiplex all those connections on a single
            // physical channel. If you don't care about multiple channels, you
            // can set the namespace to an empty string.
            namespace = '/stream';

            // Connect to the Socket.IO server.
            // The connection URL has the following format:
            //     http[s]://<domain>:<port>[/<namespace>]
            socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port + namespace);

            // Event handler for new connections.
            // The callback function is invoked when a connection with the
            // server is established.
            socket.on('connect', function() {
                socket.emit('my_event', {data: 'I\'m connected!'});
            });

            socket.on('tweet', function(msg){
                addToState(msg);
                $('#log').append('<br>' + $('<div/>').text('Location: ' + msg.data + ' - Sentiment: ' + msg.sentiment).html());
            });


            // Handlers for the different forms in the page.
            // These accept data from the user and send it to the server in a
            // variety of ways
            $('form#emit').submit(function(event) {
                socket.emit('new_filter', {data: $('#emit_data').val()});
                $("#log").html("");
                return false;
            });

            $('form#emit').submit(function(event) {
                clearMap();
                socket.emit('new_filter', {data: $('#emit_data').val()});
                $("#log").html("");
                return false;
            });

            $('#pause').click(function(){
                // socket.emit('pause');
                // $("#log").html("PAUSED");
                updateMap = false;
                return false;
            })

            $('#resume').click(function(){
                // socket.emit('resume');
                // $("#log").html("Resume");
                updateMap = true;
                return false;
            })
        });
        function disconnect(){
            socket.emit('dis');
        }
        window.onbeforeunload = function() {
            disconnect();
            return null;
        }
    </script>
    
</head>
<body>
    <div class="jumbotron">
        <h1>Tweet Location Search</h1>
    </div>
    <h4>Tweets: </h4>
    <div id="tweets"></div>
    <form id="emit" method="POST" action='#'>
        <div class="form-group">
            <label for="text">Tweet Includes: </label>                
            <input type="text" name="emit_data" id="emit_data" placeholder="Trump, Net Neutrality, etc.">                
        </div>
        <button type="submit" class="btn btn-default">Submit</button>
        <br/>
        <button type="button" class="btn btn-default" id="pause">Pause</button>
        <br/>
        <button type="button" class="btn btn-default" id="resume">Resume</button>
    </form>

    
    <div id="mapdiv" style="width: 100%; background-color:#fff; height: 500px;"></div>
    
    <h2>Locations:</h2>
    <div id="log"></div>
</body>
</html>
